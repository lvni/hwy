<!doctype html><html><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0,user-scalable=no">
<META NAME="MobileOptimized" CONTENT="240">
<title>聚缘阁</title>
    <link rel="stylesheet" href="../../css/public.css">
    <link rel="stylesheet" href="../../css/myfootprint.css">
    <link rel="stylesheet" href="../../css/index.css">
    
    <style>
        .main_bnt {
            display: -webkit-box;
            background: #b30011;
            color: white;
            border-radius: 3px;
            padding: 2px;
        }
        .gray { 
            background: #ccc;
            color: white;
        }
        .draw_navi {
            height: 40px;
            line-height: 40px;
            background: #fff;
            padding-left: 10px;
            color: #666666;
        }
        .u-nav-autowidth {
            position:static;
            margin-bottom:5px;
        }
        
        .draw_time {
            text-align: center;
            height: 3rem;
            line-height: 3rem;
            /* background: #fff; */
            color: #727372;
        }
        .draw_content {
            background: #fff;
        }
        .draw_content .item {
                height: 30px;
                line-height: 30px;
                border-bottom: 1px solid #ccc;
        }
        .draw_content .name {
                display: inline-block;
                width: 30%;
                text-align:right;
        }
        .draw_content .goods {
                display: inline-block;
                width: 50%;
                margin-left:20%;
                text-align:left;
        }
        .rule-content {
                white-space: pre-wrap;
                line-height: 2.3rem;
                color: #333;
                background: #fff;
                padding: 5px 10px;
        }
        
        a:hover, a:active, a:focus {
                color: #fff;
                text-decoration: none;
        }
        
        .sold {
            position: absolute;
            right: 10px;
            bottom:5px;
            display:none;
        }
        .u-productlist > .contbox {
            position:relative;
        }
        
        #input_address {
            position:absolute;
            top:0;
            z-index:999;
            width:100%;
            height:100%;
            background:#fff;
            display:none;
        }
        
        .guid_mask {
            width:100%;
            height: 100%;
            position: fixed;
            top:0;
            z-index: 9999;
            overflow: hidden;
            background: rgba(0,0,0,0.6);
            opacity: 0;
            display:none;
        }
        .guid_mask div {
            position: absolute;
        }
        
    </style>
</head>

<body>
<div class="u-top-msg">
    <div class="title">
        <p>聚缘阁</p>
    </div>
    <a href="../../message.html" class="msgbox">
        <img src="../../img/hw_03.png">
        <span class="msg"></span>
    </a>
    <a href="/webapp/index.html" class="turnback">
        <img src="../../img/arrowleft.png">
    </a>
</div>
<div class="details-slide indexsilde" >
    <div id="hl-swiper" class="hl-swiper cont">
        <div class="position-nav"></div>
        <div class="slides">
            <div class="slide-list"><a href="javascript:;"><img src="http://hwy-10042975.file.myqcloud.com/banner/juyuange.jpg" alt=""></a></div>
        </div>
    </div>
</div>

<nav class="u-nav-autowidth">
    <div class="on" data-index="1"> <span>寻缘</span> </div> 
    <div data-index="2"  id="drawlist"> <span>结缘名单</span></div>
    <div data-index="3"> <span>活动规则</span></div> 
</nav>

<div id="ctx_1" class="box_area">
<div id="v_code" style="display:none"></div>
<div class="u-productlist">

    
</div>
<div id="loading-more" style=" clear: both;text-align: center;">
</div>
</div>
<div id="ctx_2" style="display:none;" class="box_area">
    
</div>
<div id="ctx_3" style="display:none;" class="box_area" >
<div class="rule-content">
1.在“聚缘阁”尽情挑选心仪的翡翠珠宝（每人仅限一次参加活动资格）

2.选中心仪产品填写姓名、地址、电话并提交定单，不用付款

3.联系客服：分享活动/产品至微信朋友圈（附加文字“与玉结缘，与好相牵，分享活动/产品免费获得心仪翡翠哦，本人试过，是真的是真的是真的，重要的事情说三遍。”），并截屏给客服

4.联系客服获取抽奖码

5.直播抽奖
<div style="margin-left: 12%;">
每天下午3点抽奖
定时抽出结缘人，包邮免费送出结缘珠宝
机缘奖：0-200元  （每周一、三、五抽出五名结缘人）
福缘奖：201-500元（每周二、四抽出两名结缘人）
奇缘奖：501-1000  （每周六抽出两名结缘人）
天缘奖：1000以上 （每周六抽出一名结缘人）
</div>

6.抽奖获奖交品将于隔天寄出，周末不发货
  </div>
</div>

<div id="input_address" >
<div class="u-arrow-list">
    <div class="list"><span id="close_addr">关闭</span></div>
    
    <div class="list"><span>完善信息有机会领取 </span><span id="goods_name" style="color:red"></span></div>
    <input type="hidden" id="goods_id" name="goods_id" value="">
    <input type="hidden" id="addr_new" name="addr_new" value="1">
    <a href="javascript:;" class="list">
        <div class="contbox">
            <h3 class="title">
                <input id="select_area" type="text" readonly="" name="province_city_district" class="input" value="" placeholder="请选择所在地">
            </h3>
        </div>
        <img class="arrow" src="../../img/arrowright.png">
    </a>
    <a href="javascript:;" class="list">
        <div class="contbox">
            <h3 class="title">
                <input type="text" name="address" class="input" value="" placeholder="请输入详细地址">
            </h3>
        </div>
        <img class="arrow" src="../../img/arrowright.png">
    </a>
    <a href="javascript:;" class="list">
        <div class="contbox">
            <h3 class="title"><input type="text" name="consignee" class="input" value="" placeholder="请输入收货人姓名"></h3>
        </div>
        <img class="arrow" src="../../img/arrowright.png">
    </a>
    <a href="javascript:;" class="list">
        <div class="contbox">
            <h3 class="title"><input type="text" name="mobile" class="input" value="" placeholder="请输入手机号码"></h3>
        </div>
        <img class="arrow" src="../../img/arrowright.png">
    </a>
    <a href="javascript:;" class="list">
        <div class="contbox">
            <h3 class="title"><input type="text" name="zipcode" class="input" value="" placeholder="请输入邮编"></h3>
        </div>
        <img class="arrow" src="../../img/arrowright.png">
    </a>
    <div style="text-align:right; background:#fff;padding:5px;" >
    <button class="u-mainbutton-little" id="submit">
        <span>提交</span>
    </button></div>
</div>
</div>
<div class="guid_mask" id="mask">
<div id="choose_div"><img src="img/choose.png"  /></div>
<div id="addr_div" style="display:none;"><img src="img/addr.png?v=22"  /></div>
<div id="iknow_div"><img src="img/iknow.png" ></div>
</div>
<script type="text/template" id="list_item_template">
<div class="contbox" >
        <img src="{$goods_thumb}" onclick="javascript:location.href='details.html?id={$goods_id}&rf=act201609'">
        <div class="cont">
            <p class="name">{$goods_name}</p>
            <p class="other"><span class="money"><i>￥</i>{$goods_price}</span><span class="collection  "><a class="main_bnt" href="javascript:;" dataid='{$goods_id}'  data-name='{$goods_name}'>立即参与</a></p>
        </div>
        <div class="sold"  style="{$display}"><img src="../../img/sold.png"></div>
    </div>
</script>

<script type="text/template" id="draw_list_template">
<div>
        <div class="draw_time">{$date}</div>
        <ul class="draw_content">
            {$draw_list}
            
        </ul>
    </div>
</script>
<script type="text/template" id="draw_item_template">
    <li class="item"><span class="name">{$name}</span><span class="goods">{$goods_name}</span></li>
</script>
<script src="../../javascripts/zepto_v1.min.js"></script>
<script src="../../javascripts/main.js"></script>
<script src="../../javascripts/areaDatas.js"></script>
<script src="../../javascripts/selecter.js"></script>
<script>
$(function(){

    var page = 1;
    var pageCnt = 0;
    var loading = 0;
    var UserAI = {};
    function loadList(p) {
        Util.requestApi("?r=activity/yuanlai", {p:p}, function(data){
            if (data.errno) {
                messageBox.toast(data.errmsg);
                return;
            }
            if (data.data.page_count == 0) {
                Util.showTips($(".u-productlist"), "没有相关商品");
                return ;
            }
            var template = $("#list_item_template").html();
            var html = "";
            for (i in data.data.list) {
                var item = data.data.list[i];
                item.display = "";
                if (item.goods_number < 1) {
                    item.display = "display:block;";
                }
                html += Template.renderByTemplate(template, item);
            }
            page = data.data.page ;
            pageCnt = data.data.page_count;
            $(".u-productlist").append(html);
            if ( page >= pageCnt) {
                $("#loading-more").html("没有更多");
            }
            loading = 0;
            
            if (page == 1) {
                $("#ctx_1 img")[0].onload= function(){
                    showGuide();
                };
                
            }
        });
        
        
    }
    
    function showSubmit(goods_id, goods_tite) {
         $("#ctx_1").hide();
         $("#input_address").show();
         $("#goods_name").html(goods_tite);
         $("#goods_id").val(goods_id);
         //console.log(goods_id);
         if (uaData.u_addr) {
            var address = uaData.u_addr;
            var province_city_district = address.province + " " + address.city + " " + address.district;
            address['province_city_district'] = province_city_district;
            delete address['province'];
            delete address['city'];
            delete address['district'];
            
            $(".u-arrow-list input").each(function(i){
                var name = $(this).attr('name');
                if (name in address) {
                    $(this).val(address[name]);
                }
            });
            $("#addr_new").val(0);
            delete uaData.u_addr;
         }
    }
    
    $("#close_addr").click(function() {
        hideSubmit();
    });
    function hideSubmit() {
        $("#ctx_1").show();
         $("#input_address").hide();
    }
    
    function canLoadMore() {
        return $("#ctx_1")[0].style.display != "none" ;
    }
    
    $(window).scroll(function(){
            if (page < pageCnt && loading == 0 && canLoadMore()) {
                    $("#loading-more").html("加载中 ...");
                    loading = 1;
                    loadList(page + 1);
            }
        });
        loadList(page );
    var uaData = {};
    //获取用户活动参与情况
    Util.requestApi("?r=activity/getuserai", {}, function(data){
        
        uaData = data.data;
        if (uaData.act_ed > 0 && uaData.v_code != "") {
                //已经参与过
                $("#v_code").html("您已参与活动,抽奖码:" + uaData.v_code).show();
              
        }
        
        $(".u-productlist").delegate(".main_bnt", 'click', function(){
              if (uaData.is_login == false) {
                //没有登录
                    Util.goLogin(location.href);
                   return;
              }
              
              if (uaData.act_ed > 0) {
                //已经参与过
                if (uaData.v_code != "") {
                    messageBox.toast("您已参加了活动，不能重复参加");
                } else {
                    
                    //已参与，但还没有抽奖码
                    messageBox.confirm("您已参加了活动，联系我们的客服获取您的抽奖码", function(){
                          Util.goKefu();
                    });
                    
                }
                return;
            } else {
                    
                    //可以参加活动
                    var goods_id = $(this).attr("dataid");
                    var goods_name= $(this).attr("data-name");
                    showSubmit(goods_id , goods_name);
                
            }
              
        });
        
        
    }, 'GET', false);
    
    var DrawGetTime = new Date();
    var DrawLoaded = false;
    function getDrawList() {
        var now = new Date();
        var minus = now.getTime() - DrawGetTime.getTime();
        if (DrawLoaded && minus < 30000) {
                console.log("cached");
                return ; 
        }
       DrawLoaded = true;
       DrawGetTime = now;
        //获取中奖用户
        var area = $("#ctx_2");
        Util.showTips(area, "加载中 ...");
        Util.requestApi("?r=activity/drawlist", {}, function(data) {
               if (data.errno != 0) {
                   messageBox.toast(data.errmsg);
                   Util.showTips(area, "加载失败");
                   return ; 
               }
               
               if (data.data.length == 0) {
                   Util.showTips(area, "等待开奖中");
                   return ;
               }
               
               var html = "";
               var DlistT = $("#draw_list_template").html();
               var DitemT = $("#draw_item_template").html();
               for (date in data.data) {
                       var item = {date: date, draw_list: ''};
                        
                       for (j in data.data[date]) {
                           var ditem = data.data[date][j];
                           
                           item.draw_list += Template.renderByTemplate(DitemT, ditem);
                       }
                       
                       html += Template.renderByTemplate(DlistT, item);
               }
               
               area.html(html);
        });
        
    }
    
    $(".u-nav-autowidth div").click(function(){
        $(".u-nav-autowidth div").removeClass("on");
        $(this).addClass("on");
        var idex = $(this).attr("data-index");
        $(".box_area").hide();
        $("#ctx_" + idex).show();
        
        if (idex == 1) {
            //产品列表
            
        }
        if (idex == 2) {
            //中奖名单
            getDrawList();
        }
    });
    
    var area = new Area.selecter(
            '#select_area',
            {
                areaData : {provs : provs_data, citys : citys_data, dists : dists_data},
            }
    );
    area.init();
    
    //$("body").css("overflow", "hidden");
    $("#submit").click(function(){
        var params = Address.getAddressFormData();
        Util.requestApi("?r=activity/submit", params, function(data) {
            if (data.errno != 0) {
                messageBox.toast(data.errmsg);
            }
            if (data.errno == 0) {
                location.href = "next-step.html";
            }
        }, 'get');
    });
    
    var hash = Util.getHash();
    if (hash == "draw") {
        $("#drawlist").trigger('click');
    }
    
    function showGuide() {
        $("#mask").show();
        $(".details-slide").hide();
        $("body").css({
            overflow: 'hidden',
            height: $(window).height()  + "px",
        });
       
        $("body").bind("touchmove", function(ev) {
            event.preventDefault();
        });
        // 获取第一个“立即参与”位置
        var wWidth = $('body').width();
        
        
        
        
        $("#choose_div img").css({
            width: (wWidth * 0.8) + "px",
        });
        $("#addr_div img").css({
            width: (wWidth * 0.87) + "px",
        });
        $("#iknow_div img").css({
            width: (wWidth * 0.4) + "px",
        });

        $("#iknow_div").css({
            'bottom' : '7%',
            'left' : '50%',
            'margin-left': (- $("#iknow_div img").width() / 2) + "px", 
        });
        
       
        var currentStep = 0;
        fixedChoosePos();
        /**
         * 调整选择引导的位置
         **/
        function fixedChoosePos() {
            var offset = $("#ctx_1 .collection").eq(0).offset();
             //选择框的相对坐标
            var choose_circle_pos = {
                x: ($("#choose_div").width() * 0.32),
                y : ($("#choose_div").height() * 0.9 )
            };
            //计算第一个引导图片的新坐标
            var new_pos = {
                x: (offset.left - choose_circle_pos.x),
                y: (offset.top - choose_circle_pos.y),
            };
            

            $("#choose_div").css( {
                left: new_pos.x + "px",
                top: new_pos.y + "px",
                }
            );

        }
        
        setTimeout(function(){
            $("#mask").css({
                    opacity : "1",
            });
        }, 200)
        
        /**
          * 调整填写信息引导的位置
          **/
        function fixedpuAddrPos() {
            var targetOffset = $("#submit").offset();
            //选择框的相对坐标
            var choose_circle_pos = {
                x: ($("#addr_div").width() * 0.86),
                y : ($("#addr_div").height() * 0.76 )
            };
            //计算第一个引导图片的新坐标
            var new_pos = {
                x: (targetOffset.left - choose_circle_pos.x),
                y: (targetOffset.top - choose_circle_pos.y),
            };
            $("#addr_div").css( {
                    left: new_pos.x + "px",
                    top: new_pos.y + "px",
                    }
                );

            
            
        }
        
        $("#iknow_div").bind('click', function(){
             currentStep ++;
             if (currentStep == 1) {
                //下一步
                $("#choose_div").hide();
                $("#addr_div").show();
                showGuidSubmit("翡翠葫芦");
                fixedpuAddrPos();
             }
             if (currentStep >= 2) {
                  hideGuide() ;
             }
        });
        
        
        function showGuidSubmit(goods_tite) {
            $("#ctx_1").hide();
            $("#input_address").show();
            $("#goods_name").html(goods_tite);
            $("#input_address .u-arrow-list .list").eq(0).hide();
        }
        
        
    }
    function hideGuide() {
        $("#mask").hide();
        $("body").css("overflow", "auto");
        $("body").unbind('touchmove');
        $("#ctx_1").show();
        $("#input_address").hide();
        $(".details-slide").show();
        $("#input_address .u-arrow-list .list").eq(0).show();
        
    }
}); 
</script>
</body>
</html>
