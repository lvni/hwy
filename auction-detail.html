<!doctype html><html><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0,user-scalable=no">
<META NAME="MobileOptimized" CONTENT="240">
<title>拍卖详情</title>
    <link rel="stylesheet" href="css/public.css">
    <link rel="stylesheet" href="css/details.css">
    <link rel="stylesheet" href="css/auction.css">
    
    <link rel="stylesheet" href="javascripts/dropload/dropload.css">
</head>

<body>
<div class="u-top-msg">
    <div class="title">
        <p>拍卖详情</p>
    </div>
    <a href="javascript:history.go(-1)" class="turnback">
        <img src="img/arrowleft.png">
    </a>
</div>
<div class="auction-nav">
<span class="red" data="detail">拍卖详情</span><span data="comment">竞拍详情</span>
</div>
<div class="details-slide">
    <div id="hl-swiper" class="hl-swiper cont">
        <div class="position-nav"></div>
        <div class="slides">
        
        </div>
    </div>
</div>
<div class="productinfo-list">
    <h4 class="details-title">商品详情</h4>
    <div class="cont">
        加载中 ...
    </div>
</div>

<div class="video" id="video" style="display:none;">
    <h4 class="details-title">视频展示</h4>
    
</div>

<div class="details-infobox">
    <h4 class="details-title">图文详情</h4>
    <div class="cont">
        加载中 ...
    </div>
</div>
<div class="auction-rule">
<div class="content">
<h2 class="rule-title">洪五爷珠宝拍卖规则</h2>
1.本规则适用于本平台线上拍卖行为。任何参加拍卖的个人或机构均应仔细阅读《洪五爷拍卖规则》，拍卖期间出价即默认同意本规则。
2.竞买人是指在洪五爷客户端进行微信登陆并报名参拍（需缴纳一定的保证金）享有竞价权的个人及机构。未进行微信登陆并参拍者，只能在一定范围内浏览拍品或享受其它服务，但无资格参与竞买。
3.拍品提供材质、尺寸、重量、种水等说明文字和视频、图片材料，仅供参考。因摄影、显示器等造成的色差，以实物为准。
4.竞买人可向工作人员索要更多拍卖资料，出价则表示同意拍品现状。
5.采用竞投的方式出价，其出价数额必须比“常规竞买”程序的出价高一个竞价阶梯方可成为合格竞买人。
6.拍卖过程中，除特别规定的拍卖方式外，竞买人出价不得低于当前价，否则出价无效。到达规定时间，系统自动倒计时10秒后宣布成交。任何服务费用。洪五爷欢迎得标者自行取货物（有精美礼品送哦）。
7.拍卖期间，围观及竞买人若出现敏感词汇、不良信息、恶性参拍或其他违反拍卖规则的行为，工作人员有权屏蔽其评论、取消竞拍资格，情况恶劣者，将封号处理。
8.竞标人竞标成功后，将得到平台发送的竞标物品短信，并在平台的个人中心——“我的订单”自动生成订单。得标者应在成功之时起24小时内付清拍品款项，有特殊情况的应及时与拍卖人联系说明。拒付则平台有权采取以下措施：
（1）报名保证金不予以退还；
（2）此项拍卖视为未成交，撤消该买家在洪五爷所有其它拍品的竞投纪录，并取消其用户资格。
9.得标者成功付款后，平台将在48小时内寄出拍品。得标者承担快递费及运输风险，特殊情况将予以说明。平台为得标者包装拍品，不收取任何服务费用。欢迎自取。
10.出现下述任一情况时，本平台不承担退货责任:
A.拍品实物与描述一致或无明显缺陷；
B.因客户摄影或屏幕原因而造成与拍品原物有差异；
C.由于得标者本人原因，平台已对某拍品的限制进行提示，但该得标者仍参与竞标并成交反悔时；
D.在收到货物5个工作日之内，得标者对拍品的真实性产生怀疑但无法出具书面鉴定意见。
</div>
</div>
<div class="enroll">
<button>报名交保证金</button>
</div>
<div class="auction-offer">
<div><input  type="number" name="money" class="money"><button class="bnt_pls"> + </button> <button class="bnt_offer">出价</button></div>
<div><input type="text" name="comment" class="content" placeholder="评论" maxlength="100" ><button class="bnt_send">发送</button></div>
</div>
<a href="javascript:;" class="u-backtop">
    <img src="img/index_295.png">
    回到顶部
</a>
<div class="auction-comment">
<div class="mask"></div>
<!-- 竞拍详情-->
<div class="live">
    <img  class="headphoto"> <span class="name"></span> 
    <div class="cur_offer">
        <div>当前价:</div>
        <div class="offer_money"></div>
    </div>
</div>
<div class="comment-content">

</div>
<div></div>
</div>
<!--支付保证金确认-->
<div class="deposit_confirm">

    <div class="board">
         <h1>确认缴纳<span id="deposit_money">0</span>元保证金</h1>
         <p>1. 竞拍成功则保证金用于抵扣拍品货款</p>
         <p>2. 竞拍失败将在次日退货保证金</p>
         <p>3. 如竞拍成功后24小时内拒付货款 , 则没收保证金</p>
         
         <span class="close">x</span>
         <button id="pay_rightnow">立即支付</button>
    </div>

</div>
<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <!-- <button class="pswp__button pswp__button--share" title="Share"></button> -->

                <!-- <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button> -->

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<script id="guess_item" type="text/template">
<div class="u-autoheight" onclick="javascript:location.href='details.html?id={$goods_id}'">
                <div class="dummy"></div>
                <div class="content"><img src="{$goods_thumb}" width="100%"> </div>
            </div>
</script>
<script type="text/template" id="comment_item">
<div  class="comment-item {$ext_class}">
    <div class="avatar"><img src="{$avatar}"></div>
    <div class="chat-content">
        <div class="nickname">{$name}</div>
        <div class="arrow_box ">{$content}</div>
    </div>
</div>
</script>
<script src="javascripts/hl-swiper.js"></script>
<script src="javascripts/zepto.min.js"></script>
<script src="javascripts/main.js"></script>
<script src="javascripts/dropload/dropload.js"></script>
<script>
(function(){
    var auctionInfo = {};
    var curentMoney = 0; //当前价格
    var id = Util.getQueryString('id');
    var nCmtId = 0;  //最新的评论id
    var oCmtId = 0;  //最早的评论id
         // dropload
    
    /**
      * 获取评论
      * id 评论id ； type : new ,old  
      **/
      
    /**
        <div  class="comment-item offer">
    <div class="avatar"><img src="img/hw_06.png"></div>
    <div class="chat-content">
        <div class="nickname">昵称</div>
        <div class="arrow_box ">800元 <div class="effect">有效</div></div>
    </div>
</div>


     **/
     //动态修改评论内容的高度
    $(".comment-content").height($(window).height() - $(".live").height() - 230);
    
    var fetchCmt = function(cmt_id, type, callback) {
            Util.requestApi("?r=auction/getcomments", {id:cmt_id,actid:id,type:type}, function(data) {
                    if (data.errno) {
                        messageBox.toast(data.errmsg);
                        return ;
                    }
                   var info = data.data;
                   if (info.offer) {
                      //更新当前出价
                      $(".live .headphoto").attr("src", info.offer.avatar);
                      $(".live .name").html(info.offer.name);
                      $(".live .offer_money").html(info.offer.price + "元");
                      
                      //如果价格太大，修改字体大小
                   } else {
                      //暂无出价
                      $(".live .name").html("暂无出价");
                   }
                   var effect = '<div class="effect">有效</div>';
                   var template = $("#comment_item").html();
                   var htm = "";
                   for (i in info.list) {
                        var item = info.list[i];
                        item.ext_class = "";
                        if (item.is_me) {
                            item.ext_class += " me" ;
                        }
                        if (item.type == 1) {
                            item.ext_class += " offer";
                            item.content = item.content  + "元 " + effect;
                        }
                        htm += Template.renderByTemplate(template, item);
                        
                   }
                   
                   if (htm) {
                   
                        
                       
                       if (type == 'new') {
                          // 插入头部
                          if (nCmtId) {
                              $(htm).insertBefore($(".comment-content .comment-item").eq(0));
                          } else {
                              $(htm).insertBefore(".dropload-down");
                          }

                       } else {
                          //追加
                          $(htm).insertBefore(".dropload-down");

                       }
                       
                       if (oCmtId == 0 || type != 'new') {
                             oCmtId = info.list[info.list.length - 1].id; //第一次更新oCmtId
                       }
                       if (nCmtId == 0 || type == 'new') {
                             nCmtId = info.list[0].id; //第一次更新oCmtId
                       }
                   }
                   // dropload.resetload();
                   callback && callback(data);
                   
                    
            }, 'get', true);
    } ;
    
    
    
    var bindEvent = function() {
            $(".enroll button").click(function(){
                 $(".deposit_confirm").show();
                 Util.lockScoll();
            });
            $(".deposit_confirm .close").click(function(){
                 $(".deposit_confirm").hide();
                 Util.unlockScoll();
            });
            
            $("#pay_rightnow").click(function(){
            
                   if (auctionInfo && !auctionInfo.is_login) {
                      //未登录
                      Util.goLogin(location.href );
                   } else {
                      location.href = "auction-pay.html?actid=" + id;
                   }
                  
            });
            
            $(".bnt_send").bind('click', function() {
                //发送评论
                var comment = $(".auction-offer .content").val();
                if (comment == "") {
                    // 评论为空
                    messageBox.toast("评论内容不能为空");
                    return;
                }
                var params = {
                    'actid' : id,
                    'comment' : comment,
                };
                Util.requestApi("?r=auction/comment", params, function(data){
                     messageBox.toast(data.errmsg);
                     
                     if (data.errno == 0) {
                        //刷新评论
                        fetchCmt(nCmtId, 'new', null);
                     }
                    
                }, 'post');
                
            });
            
            //加价
            $(".auction-offer .bnt_pls").bind('click', function() {
                   var money = parseInt($(".auction-offer .money").val());
                   var step = auctionInfo.auction.ext_info.amplitude;
                   if (money == NaN || money <= 0) {
                         money = curentMoney;
                   }
                   
                   money += step;
                   $(".auction-offer .money").val(money).trigger('change');
            }); 
            
            $(".bnt_offer").bind('click', function()    {
                //出价
                var money = $(".auction-offer .money").val();
                money = parseInt(money);
                if (money != NaN && money > 0) {
                    Util.requestApi("?r=auction/offer" , {money:money,id:id}, function(data){
                        messageBox.toast(data.errmsg);
                     
                         if (data.errno == 0) {
                            //刷新评论
                            fetchCmt(nCmtId, 'new', null);
                         }
                    }, 'post');
                }
                
            });
            
            //金额变动事件
            $(".auction-offer .money").bind('change', function(){
                 var money = $(this).val();
                 money = parseInt(money);
                 if (money != NaN && money > 0) {
                     $(".bnt_offer").addClass("red");
                 } else {
                    $(".bnt_offer").removeClass("red");
                 }
            });
    } ;
    // 加载拍卖详情
    
     Util.requestApi("?r=auction/detail", {id:id}, function(data){
        if (data.errno) {
            messageBox.toast(data.errmsg);
            return ;
        }
        
        $('title').html(data.data.auction.act_name);
        $(".title p").html(data.data.auction.act_name);
        if (!data.data.goods) {
            messageBox.toast("商品不存在");
            return ;
        }
        auctionInfo = data.data;
        var goods = data.data.goods;
         $(".details-infobox .cont").html(goods.detail);
         if (goods.video != "") {
            //有视频
            var video = '<video width="100%" src="'+goods.video+'" controls="controls"></video>';
            $("#video").show().append(video);
        }
        var attrHtml = "";
        var attrItemTemplate = "<p>{$key}: {$value}</p>";
        //轮播图模版
        var slideTemplate = '<div class="slide-list"><img src="{$src}" alt=""></div>';
        for (i in goods.attr) {
            var item = goods.attr[i];
            if (item.value != '') {
                attrHtml += attrItemTemplate.replace('{$key}', item.key)
                            .replace('{$value}', item.value);
            }
        }
        var slideHtml = '';
        for (i in goods.pics) {
            var item = goods.pics[i];
            slideHtml += slideTemplate.replace('{$src}', item);
        }
        
        //设置保证金金额
        $("#deposit_money").html(auctionInfo.auction.ext_info.deposit);
        
        //设置最低加价
        $(".auction-offer .money").attr("placeholder", "起步价" + 
                            auctionInfo.auction.ext_info.start_price + "元");
        if (auctionInfo.auction.is_deposit_paid) {
            //用户已经交了保证金
            $(".auction-offer").show();
        } else {
            $(".enroll").show();
        }
        
        curentMoney = auctionInfo.auction.ext_info.start_price;
        if (auctionInfo.auction.current_offer > 0) {
             curentMoney = auctionInfo.auction.current_offer + auctionInfo.auction.ext_info.amplitude;
        }
        
        $(".auction-offer .money").val(curentMoney);
        
        bindEvent();
        $(".productinfo-list .cont").html(attrHtml);
        $(".details-slide .slides").html(slideHtml);
        var swiper = new hlSwiper("#hl-swiper", {
            loop: true, //是否循环
            autoloop: true, //是否自动循环
            speed: 3000 //间隔时间毫秒
        });
     });
     
     
     
     
     
     var dropload = $('.comment-content').dropload({
        domUp : {
            domClass   : 'dropload-up',
            domRefresh : '<div class="dropload-refresh">↓下拉刷新</div>',
            domUpdate  : '<div class="dropload-update">↑释放更新</div>',
            domLoad    : '<div class="dropload-load"><span class="loading"></span>加载中...</div>'
        },
        domDown : {
            domClass   : 'dropload-down',
            domRefresh : '<div class="dropload-refresh">↑上拉加载更多</div>',
            domLoad    : '<div class="dropload-load"><span class="loading"></span>加载中...</div>',
            domNoData  : '<div class="dropload-noData">暂无更多</div>'
        },
        autoLoad : false,
        loadUpFn : function(me){
            //加载评价
            fetchCmt(nCmtId, "new", function(data) {
                dropload.resetload();
            });
            //me.resetload();
        },
        loadDownFn : function(me){
            //me.resetload();
            fetchCmt(oCmtId, "old", function(data) {
                
                if (data.data.hasMore == 0) {
                    //没有更多了
                    dropload.lock("down");
                }
                dropload.noData(true);
                dropload.resetload();
            });
        }
    });
    
    $(".auction-nav").delegate('span', 'click', function(){
          if ($(this).hasClass('red')) {
            return;
          }
          $(".auction-nav span").removeClass("red");
          $(this).addClass("red");
          if ($(this).attr('data') == 'comment') {
            $(".auction-comment").addClass("show");
            
                if (nCmtId == 0) {
                
                    fetchCmt(nCmtId, "old", function(data){
                          //第一次加载如果为空
                          
                          if (data.data.hasMore == 0) {
                               dropload.lock("down");
                               dropload.noData(true);
                                dropload.resetload();
                          }
                    });
                } else {
                    fetchCmt(nCmtId, "new", null );
                }
            
          } else {
          $(".auction-comment").removeClass("show");
          }
          
     });
     


})();
</script>

</body>
</html>
